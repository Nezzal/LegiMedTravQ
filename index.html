<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LegiMedTrav-Q | Mission ‚Äî B√¢tir la Pr√©vention</title>
  <meta name="description" content="Outil d'aide √† la d√©cision √©thique et r√©glementaire pour les m√©decins du travail en Alg√©rie.">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid #333;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.4em;
      color: #fbbf24;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      color: #a0a0a0;
      max-width: 800px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .tab {
      background: #2d2d2d;
      color: #e0e0e0;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tab:hover {
      background: #3d3d3d;
    }

    .tab.active {
      background: #fbbf24;
      color: #121212;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* DOSSIER 1 STYLES */
    #dossier1 {
      padding: 20px;
      background-color: #1a1a1a;
      border-radius: 8px;
      color: #e0e0e0;
      font-family: 'Courier New', Courier, monospace;
    }

    .folder-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .folder-header h2 {
      font-size: 1.4em;
      color: #fbbf24;
      margin: 0;
    }

    .affaire-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .affaire-tab {
      background: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .affaire-tab:hover {
      background: #3d3d3d;
    }

    .affaire-tab.active {
      background: #fbbf24;
      color: #121212;
      border-color: #fbbf24;
    }

    .affaire-content {
      display: none;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 6px;
      border-left: 4px solid #fbbf24;
      margin-top: 10px;
    }

    .affaire-content.active {
      display: block;
    }

    .lock-icon {
      color: #fbbf24;
      margin-right: 8px;
    }

    .case-summary {
      background: #252525;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-style: italic;
      border-left: 3px solid #fbbf24;
    }

    .question-section ol {
      padding-left: 20px;
      line-height: 1.6;
    }

    .question-section ol li {
      margin: 8px 0;
    }

    .response-format {
      margin: 20px 0;
      padding: 15px;
      background: #252525;
      border-radius: 6px;
      font-size: 0.9em;
      border-left: 3px solid #fbbf24;
    }

    .ai-button-container {
      text-align: center;
      margin-top: 25px;
    }

    .ai-button {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #121212;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 1em;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .ai-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    .ai-button:active {
      transform: translateY(0);
    }

    /* ZONE DE R√âPONSE IA */
    .ai-response-box {
      margin-top: 25px;
      border-radius: 8px;
      overflow: hidden;
      background: #1a1a1a;
      border: 1px solid #444;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .ai-response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #252525;
      padding: 12px 16px;
      border-bottom: 1px solid #333;
    }

    .ai-response-header h4 {
      color: #fbbf24;
      margin: 0;
      font-size: 1.1em;
    }

    .ai-clear-btn {
      background: #444;
      color: #fbbf24;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .ai-clear-btn:hover {
      background: #555;
    }

    .ai-response-content {
      padding: 16px;
      min-height: 60px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .ai-response-text {
      white-space: normal;
    }

    .ref {
      color: #fbbf24;
      font-weight: bold;
    }

    .ai-response-content::-webkit-scrollbar {
      width: 6px;
    }
    .ai-response-content::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    .ai-response-content::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 3px;
    }

    footer {
      margin-top: 50px;
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 0.9em;
      border-top: 1px solid #333;
    }

    @media (max-width: 600px) {
      .tabs { flex-direction: column; }
      h1 { font-size: 2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üõ°Ô∏è LegiMedTrav-Q</h1>
      <p class="subtitle">Mission ‚Äî B√¢tir la Pr√©vention<br><em>Un outil pour les m√©decins du travail en Alg√©rie ‚Äî Con√ßu par Nezzal Abdelmalek</em></p>
    </header>

    <!-- Navigation principale -->
    <div class="tabs">
      <button class="tab active" data-tab="briefing">Briefing</button>
      <button class="tab" data-tab="dossier1">Dossier 1</button>
      <button class="tab" data-tab="dossier2">Dossier 2</button>
      <button class="tab" data-tab="dossier3">Dossier 3</button>
      <button class="tab" data-tab="dossier4">Dossier 4</button>
      <button class="tab" data-tab="debriefing">D√©briefing</button>
    </div>

    <!-- ================ BRIEFING ================ -->
    <div id="briefing" class="tab-content active">
      <h2>üìå Briefing narratif</h2>
      <p><strong>√Ä l‚Äôattention du Directeur de la M√©decine du Travail,</strong></p>
      <p>Dans le cadre de la modernisation de notre dispositif SST, vous √™tes charg√©¬∑e d‚Äô√©valuer la conformit√© √©thique et r√©glementaire de cas r√©els soumis par les √©quipes terrain ‚Äî en vous appuyant sur <strong>LegiMedTrav-AI</strong>, notre assistant juridique d√©di√© √† la m√©decine du travail en Alg√©rie.</p>
      <p>üìå <strong>Votre mission :</strong> Lire ‚Üí Interroger l‚ÄôIA ‚Üí D√©cider ‚Äî en vous fondant sur les textes alg√©riens (Loi 88-07, D√©crets 92-276 & 93-120, etc.)</p>
      <p>‚û°Ô∏è Passez aux dossiers pour commencer.</p>
    </div>

    <!-- ================ DOSSIER 1 (Updated) ================ -->
    <div id="dossier1" class="tab-content">
      <div class="folder-header">
        <span class="folder-icon">üìÅ</span>
        <h2>Dossier 1 : Dilemmes √©thiques et devoirs du m√©decin</h2>
      </div>

      <!-- Onglets d'affaires -->
      <div class="affaire-tabs">
        <button class="affaire-tab active" data-affaire="1">Affaire n¬∞1</button>
        <button class="affaire-tab" data-affaire="2">Affaire n¬∞2</button>
        <button class="affaire-tab" data-affaire="3">Affaire n¬∞3</button>
      </div>

      <!-- Contenu des affaires -->
      <div id="affaire1" class="affaire-content active">
        <h3><span class="lock-icon">üîí</span> Affaire n¬∞1 : Le secret m√©dical sous pression</h3>
        <div class="case-summary">
          Un Directeur des Ressources Humaines exerce une pression sur le m√©decin du travail pour obtenir des informations m√©dicales sur un salari√© en arr√™ts maladie r√©p√©t√©s.
        </div>

        <div class="question-section">
          <h4><span class="question-icon">üìã</span> Question √† poser √† LegiMedTrav :</h4>
          <ol>
            <li><strong>SECRET PROFESSIONNEL - CADRE L√âGAL :</strong>
              <ol type="a">
                <li>Le secret professionnel du m√©decin du travail comporte-t-il des exceptions face aux demandes d'un employeur ?</li>
                <li>Citez les articles PR√âCIS du Code de D√©ontologie M√©dicale (D√©cret ex√©cutif n¬∞ 92-276 du 06 juillet 1992, JO n¬∞ 52 du 08 juillet 1992, page 1160) d√©finissant l'√©tendue et les limites du secret professionnel.</li>
                <li>Pr√©cisez le num√©ro d'article ET reproduisez l'extrait pertinent du texte.</li>
              </ol>
            </li>
            <li><strong>COMMUNICATION AUTORIS√âE :</strong>
              <ol type="a">
                <li>Quelles informations le m√©decin du travail PEUT-il l√©galement communiquer √† l'employeur concernant un salari√© ?</li>
                <li>Quelles informations sont STRICTEMENT INTERDITES de communication ?</li>
                <li>Citez l'article du D√©cret 93-120 (relatif √† l'organisation de la m√©decine du travail) pr√©cisant le contenu de l'avis d'aptitude.</li>
              </ol>
            </li>
            <li><strong>CONS√âQUENCES JURIDIQUES D'UNE VIOLATION :</strong>
              <ol type="a">
                <li>Listez les trois types de responsabilit√©s engag√©es en cas de violation du secret professionnel.</li>
                <li>Pour chaque type, citez la base l√©gale PR√âCISE (loi, d√©cret, code, article).</li>
                <li>Pr√©cisez les sanctions applicables selon chaque texte.</li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="response-format">
          <strong>FORMAT DE R√âPONSE EXIG√â :</strong><br>
          - Chaque affirmation doit √™tre suivie de : [R√©f√©rence : Texte, Article, Alin√©a]<br>
          - Exemple : "Le secret professionnel est absolu. [R√©f√©rence : Code de D√©ontologie M√©dicale, D√©cret 92-276, Article 36, Alin√©a 1]"
        </div>

        <div class="ai-button-container">
          <button class="ai-button" type="button">‚ú® Interroger LegiMedTrav-AI</button>
        </div>
      </div>

      <div id="affaire2" class="affaire-content">
        <h3><span class="lock-icon">üîí</span> Affaire n¬∞2 : L'obligation de conseil oubli√©e</h3>
        <div class="case-summary">
          Lors d‚Äôune visite, vous d√©tectez un risque psychosocial majeur, mais le m√©decin r√©f√©rent ne signale rien √† l‚Äôemployeur. Vous vous interrogez sur votre responsabilit√©.
        </div>

        <div class="question-section">
          <h4><span class="question-icon">üìã</span> Question √† poser √† LegiMedTrav :</h4>
          <ol>
            <li><strong>MISSION FONDAMENTALE DU M√âDECIN DU TRAVAIL :</strong>
              <ol type="a">
                <li>Selon la Loi 88-07 relative √† l'hygi√®ne, la s√©curit√© et la m√©decine du travail, quelle est la nature de la mission du m√©decin du travail ?</li>
                <li>Citez PR√âCIS√âMENT l'article de la Loi 88-07 d√©finissant cette mission.</li>
                <li>Reproduisez l'extrait pertinent du texte l√©gislatif.</li>
              </ol>
            </li>
            <li><strong>√âTENDUE DE LA MISSION - INDIVIDU VS COLLECTIF :</strong>
              <ol type="a">
                <li>Le r√¥le du m√©decin du travail se limite-t-il au suivi m√©dical individuel des salari√©s ?</li>
                <li>Quelle obligation a-t-il concernant l'action sur le milieu de travail ?</li>
                <li>Citez l'article de la Loi 88-07 pr√©cisant cette obligation d'action sur l'environnement de travail.</li>
                <li>Le m√©decin du travail a-t-il une contrainte temporelle r√©glementaire (proportion de temps minimum) pour son action sur le milieu ? Si oui, citez le texte. Si non, pr√©cisez que cette proportion n'existe pas dans la l√©gislation alg√©rienne.</li>
              </ol>
            </li>
            <li><strong>OBLIGATION DE CONSEIL ENVERS L'EMPLOYEUR :</strong>
              <ol type="a">
                <li>Le m√©decin du travail a-t-il une obligation de conseil actif envers l'employeur ?</li>
                <li>Citez l'article du D√©cret ex√©cutif n¬∞ 93-120 du 15 mai 1993 (relatif √† l'organisation de la m√©decine du travail) d√©finissant cette fonction de conseil.</li>
                <li>Quels sont les outils r√©glementaires permettant au m√©decin de formaliser ses recommandations √† l'employeur ? (pr√©cisez notamment le r√¥le du rapport annuel)</li>
              </ol>
            </li>
            <li><strong>CONS√âQUENCES JURIDIQUES D'UN D√âFAUT D'ACTION COLLECTIVE :</strong>
              <ol type="a">
                <li>Un m√©decin qui se limite aux soins individuels sans agir sur les causes collectives identifi√©es engage-t-il sa responsabilit√© ?</li>
                <li>Sur quelle base l√©gale cette responsabilit√© peut-elle √™tre invoqu√©e ?</li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="response-format">
          <strong>FORMAT DE R√âPONSE EXIG√â :</strong><br>
          - Chaque affirmation doit √™tre suivie de : [R√©f√©rence : Texte, Article, Alin√©a]<br>
          - Pr√©cisez si une information n'existe PAS dans la l√©gislation alg√©rienne (exemple : "Il n'existe aucune proportion temporelle fix√©e par la loi alg√©rienne pour l'action sur le milieu")
        </div>

        <div class="ai-button-container">
          <button class="ai-button" type="button">‚ú® Interroger LegiMedTrav-AI</button>
        </div>
      </div>

      <div id="affaire3" class="affaire-content">
        <h3><span class="lock-icon">üîí</span> Affaire n¬∞3 : La double loyaut√© impossible</h3>
        <div class="case-summary">
          Un salari√© vous confie qu‚Äôil subit des menaces de licenciement s‚Äôil refuse de travailler en pr√©sence de substances dangereuses. L'employeur vous demande de certifier son aptitude.
        </div>

        <div class="question-section">
          <h4><span class="question-icon">üìã</span> Question √† poser √† LegiMedTrav :</h4>
          <ol>
            <li><strong>CONFLIT D'INT√âR√äTS ET LOYAUT√â DU M√âDECIN :</strong>
              <ol type="a">
                <li>Le m√©decin du travail peut-il √™tre tenu pour responsable s'il certifie l'aptitude d‚Äôun salari√© dans un contexte de menace ou de coercition ?</li>
                <li>Quel principe d√©ontologique s'applique ici ? Citez l'article du Code de D√©ontologie M√©dicale applicable.</li>
                <li>Le m√©decin du travail est-il tenu de refuser de signer un avis d'aptitude s‚Äôil a connaissance d'une situation de danger ou de pression ?</li>
              </ol>
            </li>
            <li><strong>AVIS D'APTITUDE ET DANGERS IDENTIFI√âS :</strong>
              <ol type="a">
                <li>Si un danger est identifi√© sur le poste, quelles mentions doivent figurer obligatoirement dans l'avis d'aptitude ?</li>
                <li>Le m√©decin peut-il conditionner l'aptitude √† des am√©nagements sp√©cifiques ? Si oui, citez le texte r√©glementaire autorisant cette pratique.</li>
                <li>En cas de d√©saccord entre le m√©decin et l'employeur sur les conditions de travail, quel recours existe-t-il ?</li>
              </ol>
            </li>
            <li><strong>PROTECTION DU SALARI√â ET DROIT √Ä REFUSER :</strong>
              <ol type="a">
                <li>Le salari√© a-t-il un droit l√©gal de refuser un poste dangereux ? Citez l'article de la Loi 88-07 qui le garantit.</li>
                <li>Le m√©decin du travail peut-il appuyer juridiquement ce refus ? Comment ?</li>
                <li>Quelle est la cons√©quence l√©gale pour l'employeur qui punit un salari√© ayant exerc√© ce droit ?</li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="response-format">
          <strong>FORMAT DE R√âPONSE EXIG√â :</strong><br>
          - Chaque affirmation doit √™tre suivie de : [R√©f√©rence : Texte, Article, Alin√©a]<br>
          - Exemple : "Le m√©decin du travail ne peut certifier l'aptitude en cas de danger av√©r√©. [R√©f√©rence : Code de D√©ontologie M√©dicale, D√©cret 92-276, Article 37, Alin√©a 2]"
        </div>

        <div class="ai-button-container">
          <button class="ai-button" type="button">‚ú® Interroger LegiMedTrav-AI</button>
        </div>
      </div>
    </div>

    <!-- ================ DOSSIER 2 ================ -->
    <div id="dossier2" class="tab-content">
      <h2>üìÅ Dossier 2 : Exposition aux agents chimiques</h2>
      <p><em>Contenu √† compl√©ter ult√©rieurement.</em></p>
    </div>

    <!-- ================ DOSSIER 3 ================ -->
    <div id="dossier3" class="tab-content">
      <h2>üìÅ Dossier 3 : Sant√© mentale et risques psychosociaux</h2>
      <p><em>Contenu √† compl√©ter ult√©rieurement.</em></p>
    </div>

    <!-- ================ DOSSIER 4 ================ -->
    <div id="dossier4" class="tab-content">
      <h2>üìÅ Dossier 4 : Suivi post-professionnel & pathologies √©mergentes</h2>
      <p><em>Contenu √† compl√©ter ult√©rieurement.</em></p>
    </div>

    <!-- ================ DEBRIEFING ================ -->
    <div id="debriefing" class="tab-content">
      <h2>üéØ D√©briefing & Prochaines √©tapes</h2>
      <p>‚úÖ Vous avez explor√© les principaux dilemmes √©thiques du m√©decin du travail.</p>
      <p>‚û°Ô∏è Prochaines actions :</p>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li>Int√©gration de l‚Äôappel √† l‚ÄôIA via <code>legimedtravq-proxy-clean</code></li>
        <li>Alimentation des dossiers 2 √† 4 avec cas r√©els</li>
        <li>D√©ploiement CI/CD (GitHub Actions)</li>
      </ul>
      <p><em>Merci pour votre engagement dans la pr√©vention ‚Äî SST, c‚Äôest d‚Äôabord de l‚Äôhumain.</em></p>
    </div>

    <footer>
      üõ†Ô∏è <strong>LegiMedTrav-Q</strong> ‚Äî Projet d√©velopp√© par <a href="https://github.com/Nezzal" style="color:#fbbf24">Nezzal Abdelmalek</a> ‚Ä¢ Nov. 2025<br>
      üåê D√©ploy√© sur <a href="https://nezzal.github.io/LegiMedTravQ/" style="color:#fbbf24">GitHub Pages</a>
    </footer>
  </div>

  <!-- SCRIPTS -->
  <script>
    // Encapsule tout le code dans une IIFE pour √©viter les conflits
    (function() {
      try {
        document.addEventListener('DOMContentLoaded', function () {
          const mainTabs = document.querySelectorAll('.tab');
          const mainContents = document.querySelectorAll('.tab-content');

          mainTabs.forEach(tab => {
            tab.addEventListener('click', () => {
              mainTabs.forEach(t => t.classList.remove('active'));
              mainContents.forEach(c => c.classList.remove('active'));

              tab.classList.add('active');
              document.getElementById(tab.dataset.tab).classList.add('active');
            });
          });

          // Gestion des onglets d'affaires dans Dossier 1
          const affaireTabs = document.querySelectorAll('.affaire-tab');
          const affaireContents = document.querySelectorAll('.affaire-content');

          affaireTabs.forEach(tab => {
            tab.addEventListener('click', () => {
              affaireTabs.forEach(t => t.classList.remove('active'));
              affaireContents.forEach(c => c.classList.remove('active'));

              tab.classList.add('active');
              document.getElementById(`affaire${tab.dataset.affaire}`).classList.add('active');
            });
          });

          if (affaireContents.length > 0) {
            affaireContents[0].classList.add('active');
          }

          // === üî• ACTIVATION DES BOUTONS IA ===
          const aiButtons = document.querySelectorAll('.ai-button');
          aiButtons.forEach(button => {
            button.addEventListener('click', handleAIButtonClick);
          });
        });

        // üì• R√©cup√®re le texte complet de l'affaire active
        function getCurrentQuestion() {
          const activeAffaire = document.querySelector('.affaire-content.active');
          if (!activeAffaire) return null;

          const title = activeAffaire.querySelector('h3').innerText.trim();
          const summary = activeAffaire.querySelector('.case-summary').innerText.trim();
          const questionList = activeAffaire.querySelector('.question-section ol').innerText.trim();
          const format = activeAffaire.querySelector('.response-format').innerText
            .replace('FORMAT DE R√âPONSE EXIG√â :', '').trim();

          return `${title}\n\nContexte : ${summary}\n\n‚ùì Question d√©taill√©e :\n${questionList}\n\nüìù Exigence de format :\n${format}`;
        }

        // üé® Formatage basique style Markdown ‚Üí HTML
        function formatResponse(text) {
          if (!text) return '';
          return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **gras**
            .replace(/\[(R√©f√©rence.*?)\]/g, '<span class="ref">[$1]</span>') // [R√©f√©rence : ...] ‚Üí jaune
            .replace(/\n{2,}/g, '\n\n') // normaliser sauts
            .replace(/\n/g, '<br>')
            .replace(/‚Ä¢/g, '‚Ä¢'); // garder les puces
        }

        // üöÄ Envoi √† l'IA + affichage dans la zone d√©di√©e
        async function askLegiMedTravAI(question) {
          const activeAffaire = document.querySelector('.affaire-content.active');
          if (!activeAffaire) return;

          // Cr√©er ou r√©cup√©rer la zone de r√©ponse
          let responseBox = activeAffaire.querySelector('.ai-response-box');
          if (!responseBox) {
            responseBox = document.createElement('div');
            responseBox.className = 'ai-response-box';
            responseBox.innerHTML = `
              <div class="ai-response-header">
                <h4>ü§ñ R√©ponse de LegiMedTrav-AI</h4>
                <button class="ai-clear-btn" type="button">üóëÔ∏è Effacer</button>
              </div>
              <div class="ai-response-content"><p>Chargement en cours‚Ä¶</p></div>
            `;
            activeAffaire.appendChild(responseBox);

            // Gestion du bouton "Effacer"
            responseBox.querySelector('.ai-clear-btn').addEventListener('click', () => {
              responseBox.remove();
            });
          } else {
            // R√©initialiser le contenu
            responseBox.querySelector('.ai-response-content').innerHTML = '<p>Chargement en cours‚Ä¶</p>';
          }

          try {
            const response = await fetch('https://legimedtravq-proxy-clean.vercel.app/api/route', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                messages: [
                  {
                    role: "system",
                    content: "Vous √™tes LegiMedTrav-AI, un expert juridique en m√©decine du travail en Alg√©rie. R√©pondez de fa√ßon pr√©cise, p√©dagogique, et toujours avec des r√©f√©rences l√©gales exactes [Texte, Article, Alin√©a]."
                  },
                  { role: "user", content: question }
                ]
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status} ‚Äî ${response.statusText}`);
            }

            const data = await response.json();

            // üîç Gestion robuste de la structure de r√©ponse
            let rawAnswer = "‚ùå Aucune r√©ponse re√ßue.";
            try {
              if (!data) {
                throw new Error("Donn√©es nulles");
              }

              // Cas 1 : format standard (OpenRouter, non-stream√©)
              if (Array.isArray(data.choices) && data.choices.length > 0) {
                const choice = data.choices[0];
                if (choice.message && typeof choice.message.content === 'string') {
                  rawAnswer = choice.message.content;
                } else if (choice.delta && typeof choice.delta.content === 'string') {
                  rawAnswer = choice.delta.content;
                } else {
                  throw new Error("Structure 'message.content' ou 'delta.content' manquante");
                }
              } 
              // Cas 2 : erreurs renvoy√©es par l'API
              else if (data.error) {
                rawAnswer = `‚ùå Erreur API : ${data.error.message || JSON.stringify(data.error)}`;
              } 
              // Cas 3 : autre format
              else {
                rawAnswer = `‚ö†Ô∏è Format inattendu. R√©ponse brute : <pre>${JSON.stringify(data, null, 2)}</pre>`;
              }
            } catch (parseErr) {
              rawAnswer = `‚ùå Erreur de traitement : ${parseErr.message}\n\nDonn√©es re√ßues : <pre>${JSON.stringify(data, null, 2)}</pre>`;
            }

            const formattedAnswer = formatResponse(rawAnswer);
            responseBox.querySelector('.ai-response-content').innerHTML = `
              <div class="ai-response-text">${formattedAnswer}</div>
              <div style="margin-top: 15px; text-align: right;">
                <button class="copy-btn" type="button">üìã Copier la r√©ponse</button>
              </div>
            `;

            // Bouton "Copier la r√©ponse"
            responseBox.querySelector('.copy-btn').addEventListener('click', () => {
              navigator.clipboard.writeText(rawAnswer.replace(/<[^>]*>/g, '')).then(() => {
                alert('‚úÖ R√©ponse copi√©e dans le presse-papiers.');
              }).catch(err => {
                alert('‚ùå Impossible de copier. Essayez manuellement.');
              });
            });

          } catch (err) {
            console.error('‚ùå Erreur IA globale:', err);
            let errorMsg = `‚ùå Erreur r√©seau ou serveur : ${err.message}`;
            if (err.name === 'TypeError' && err.message.includes('fetch')) {
              errorMsg += '\n\nüí° V√©rifiez votre connexion Internet.';
            }
            responseBox.querySelector('.ai-response-content').innerHTML = `
              <div style="color:#ef4444; padding: 15px; border-left: 4px solid #ef4444; background: #2a1a1a;">
                <h5>‚ùå √âchec de la requ√™te</h5>
                <p>${errorMsg}</p>
                <p>üëâ Testez manuellement :</p>
                <pre style="background:#1a1a1a; padding:10px; border-radius:4px; margin:10px 0; font-family:monospace; overflow-x:auto;">curl -X POST https://legimedtravq-proxy-clean.vercel.app/api/route \\
  -H "Content-Type: application/json" \\
  -d '{"messages": [{"role":"user","content":"Test"}]}'</pre>
              </div>
            `;
          }
        }

        // üñ±Ô∏è Gestionnaire du clic
        function handleAIButtonClick(event) {
          const question = getCurrentQuestion();
          if (!question) {
            alert('‚ö†Ô∏è Impossible de r√©cup√©rer la question. S√©lectionnez une affaire.');
            return;
          }
          askLegiMedTravAI(question);
        }

      } catch (err) {
        console.error('‚ùå Erreur critique dans LegiMedTravQ:', err);
        alert('‚ö†Ô∏è Une erreur technique emp√™che le bon fonctionnement. Essayez en mode navigation priv√©e ou contactez le d√©veloppeur.');
      }
    })();
  </script>
</body>
</html>